<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .url-test {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            word-break: break-all;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å¿«é€Ÿä¿®å¾©æ¸¬è©¦</h1>
        <p>é€™å€‹å·¥å…·æœƒæ¸¬è©¦ä¸åŒçš„æ•¸æ“šåº« URL ä¾†æ‰¾åˆ°æ­£ç¢ºçš„é…ç½®</p>

        <div class="test-section">
            <h3>ğŸ” æ¸¬è©¦ä¸åŒçš„æ•¸æ“šåº« URL</h3>
            <div id="urlTests"></div>
            <button onclick="testAllUrls()">æ¸¬è©¦æ‰€æœ‰ URL</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æˆ¿é–“ä»£è™Ÿæ¸¬è©¦</h3>
            <div id="roomTest" class="status info">ç­‰å¾…æ¸¬è©¦...</div>
            <button onclick="testRoomId()" id="roomTestBtn" disabled>æ¸¬è©¦æˆ¿é–“ä»£è™Ÿ</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
            <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            <div id="log"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        const baseConfig = {
            apiKey: "AIzaSyD5ytWrUOI6UIUBIcKpF3fyODQR2pXFMmY",
            authDomain: "score-calculation-ef584.firebaseapp.com",
            projectId: "score-calculation-ef584",
            storageBucket: "score-calculation-ef584.firebasestorage.app",
            messagingSenderId: "634074718336",
            appId: "1:634074718336:web:38960860ad796197a50665",
            measurementId: "G-R6NT2QJQSC"
        };

        // å¯èƒ½çš„æ•¸æ“šåº« URL
        const possibleUrls = [
            "https://score-calculation-ef584-default-rtdb.firebaseio.com",
            "https://score-calculation-ef584-default-rtdb.asia-southeast1.firebasedatabase.app",
            "https://score-calculation-ef584-default-rtdb.europe-west1.firebasedatabase.app",
            "https://score-calculation-ef584-default-rtdb.us-central1.firebasedatabase.app"
        ];

        let workingUrl = null;
        let workingDatabase = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testUrl(url) {
            log(`æ¸¬è©¦ URL: ${url}`);
            
            try {
                // ä½¿ç”¨ fetch æ¸¬è©¦ URL å¯é”æ€§
                const response = await fetch(`${url}/.json`);
                log(`HTTP ç‹€æ…‹: ${response.status}`);
                
                if (response.status === 200) {
                    log(`âœ… URL å¯é”: ${url}`);
                    return { success: true, url: url };
                } else if (response.status === 401) {
                    log(`âš ï¸ URL å­˜åœ¨ä½†éœ€è¦èªè­‰: ${url}`);
                    return { success: true, url: url, needsAuth: true };
                } else {
                    log(`âŒ URL è¿”å›éŒ¯èª¤ç‹€æ…‹: ${response.status}`);
                    return { success: false, status: response.status };
                }
            } catch (error) {
                log(`âŒ URL æ¸¬è©¦å¤±æ•—: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        async function testFirebaseWithUrl(url) {
            log(`æ¸¬è©¦ Firebase é€£æ¥: ${url}`);
            
            try {
                const config = { ...baseConfig, databaseURL: url };
                
                // é‡æ–°åˆå§‹åŒ– Firebase
                if (firebase.apps.length > 0) {
                    firebase.app().delete();
                }
                
                firebase.initializeApp(config);
                const database = firebase.database();
                
                // æ¸¬è©¦é€£æ¥
                const testRef = database.ref('.info/connected');
                
                return new Promise((resolve) => {
                    const timeout = setTimeout(() => {
                        log(`â° Firebase é€£æ¥è¶…æ™‚: ${url}`);
                        resolve({ success: false, error: 'timeout' });
                    }, 5000);
                    
                    testRef.once('value', (snapshot) => {
                        clearTimeout(timeout);
                        if (snapshot.val() === true) {
                            log(`âœ… Firebase é€£æ¥æˆåŠŸ: ${url}`);
                            resolve({ success: true, database: database });
                        } else {
                            log(`âŒ Firebase é€£æ¥å¤±æ•—: ${url}`);
                            resolve({ success: false, error: 'not connected' });
                        }
                    }, (error) => {
                        clearTimeout(timeout);
                        log(`âŒ Firebase éŒ¯èª¤: ${error.message}`);
                        resolve({ success: false, error: error.message });
                    });
                });
                
            } catch (error) {
                log(`âŒ Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        async function testAllUrls() {
            log('=== é–‹å§‹æ¸¬è©¦æ‰€æœ‰å¯èƒ½çš„æ•¸æ“šåº« URL ===');
            
            const urlTestsDiv = document.getElementById('urlTests');
            urlTestsDiv.innerHTML = '';
            
            for (const url of possibleUrls) {
                const testDiv = document.createElement('div');
                testDiv.className = 'url-test';
                testDiv.innerHTML = `
                    <div>æ¸¬è©¦: ${url}</div>
                    <div id="result-${possibleUrls.indexOf(url)}" class="status info">æ¸¬è©¦ä¸­...</div>
                `;
                urlTestsDiv.appendChild(testDiv);
                
                const resultDiv = document.getElementById(`result-${possibleUrls.indexOf(url)}`);
                
                // å…ˆæ¸¬è©¦ HTTP å¯é”æ€§
                const httpResult = await testUrl(url);
                
                if (httpResult.success) {
                    // å†æ¸¬è©¦ Firebase é€£æ¥
                    const firebaseResult = await testFirebaseWithUrl(url);
                    
                    if (firebaseResult.success) {
                        resultDiv.textContent = 'âœ… é€£æ¥æˆåŠŸï¼';
                        resultDiv.className = 'status success';
                        workingUrl = url;
                        workingDatabase = firebaseResult.database;
                        
                        log(`ğŸ‰ æ‰¾åˆ°å¯ç”¨çš„æ•¸æ“šåº« URL: ${url}`);
                        document.getElementById('roomTestBtn').disabled = false;
                        
                        // æ›´æ–°å…¶ä»–æ¸¬è©¦ç‚ºæˆåŠŸç‹€æ…‹
                        document.getElementById('roomTest').textContent = 'æº–å‚™æ¸¬è©¦æˆ¿é–“ä»£è™ŸåŠŸèƒ½';
                        document.getElementById('roomTest').className = 'status info';
                        
                        break;
                    } else {
                        resultDiv.textContent = `âŒ Firebase é€£æ¥å¤±æ•—: ${firebaseResult.error}`;
                        resultDiv.className = 'status error';
                    }
                } else {
                    resultDiv.textContent = `âŒ URL ä¸å¯é”: ${httpResult.error || httpResult.status}`;
                    resultDiv.className = 'status error';
                }
            }
            
            if (!workingUrl) {
                log('âŒ æ²’æœ‰æ‰¾åˆ°å¯ç”¨çš„æ•¸æ“šåº« URL');
                log('ğŸ’¡ å»ºè­°ï¼šè«‹æª¢æŸ¥ Firebase Console ä¸­çš„ Realtime Database æ˜¯å¦å·²å‰µå»º');
            }
        }

        async function testRoomId() {
            if (!workingDatabase) {
                log('âŒ æ²’æœ‰å¯ç”¨çš„æ•¸æ“šåº«é€£æ¥');
                return;
            }
            
            log('=== æ¸¬è©¦æˆ¿é–“ä»£è™ŸåŠŸèƒ½ ===');
            
            // ç”Ÿæˆæ¸¬è©¦æˆ¿é–“ ID
            const testRoomId = 'test_' + Math.random().toString(36).substr(2, 6);
            log(`ç”Ÿæˆæ¸¬è©¦æˆ¿é–“ ID: ${testRoomId}`);
            
            try {
                // æ¸¬è©¦æˆ¿é–“æ•¸æ“šå¯«å…¥
                const roomRef = workingDatabase.ref('rooms/' + testRoomId + '/scores');
                const testScores = {
                    1: 0, 2: 0, 3: 0, 4: 0, 5: 0,
                    6: 0, 7: 0, 8: 0, 9: 0
                };
                
                await roomRef.set(testScores);
                log('âœ… æˆ¿é–“æ•¸æ“šå¯«å…¥æˆåŠŸ');
                
                // æ¸¬è©¦æ•¸æ“šè®€å–
                const snapshot = await roomRef.once('value');
                if (snapshot.exists()) {
                    log('âœ… æˆ¿é–“æ•¸æ“šè®€å–æˆåŠŸ');
                    log(`ğŸ“Š è®€å–åˆ°çš„åˆ†æ•¸: ${JSON.stringify(snapshot.val())}`);
                    
                    // æ¸¬è©¦åˆ†æ•¸æ›´æ–°
                    const updatedScores = { ...testScores };
                    updatedScores[1] = 10;
                    await roomRef.set(updatedScores);
                    log('âœ… åˆ†æ•¸æ›´æ–°æ¸¬è©¦æˆåŠŸ');
                    
                    document.getElementById('roomTest').textContent = 'âœ… æˆ¿é–“ä»£è™ŸåŠŸèƒ½æ¸¬è©¦é€šéï¼';
                    document.getElementById('roomTest').className = 'status success';
                    
                    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
                    await workingDatabase.ref('rooms/' + testRoomId).remove();
                    log('ğŸ§¹ æ¸¬è©¦æ•¸æ“šå·²æ¸…ç†');
                    
                    // é¡¯ç¤ºæ­£ç¢ºçš„é…ç½®
                    log('ğŸ‰ æ¸¬è©¦å®Œæˆï¼è«‹ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š');
                    log(`databaseURL: "${workingUrl}"`);
                    
                } else {
                    throw new Error('æ•¸æ“šè®€å–å¤±æ•—');
                }
                
            } catch (error) {
                log(`âŒ æˆ¿é–“æ¸¬è©¦å¤±æ•—: ${error.message}`);
                document.getElementById('roomTest').textContent = `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                document.getElementById('roomTest').className = 'status error';
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•é–‹å§‹æ¸¬è©¦
        window.addEventListener('load', function() {
            log('ğŸš€ å¿«é€Ÿä¿®å¾©æ¸¬è©¦å·¥å…·å•Ÿå‹•');
            setTimeout(testAllUrls, 1000);
        });
    </script>
</body>
</html>
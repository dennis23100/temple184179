<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .url-test {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            word-break: break-all;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å¿«é€Ÿä¿®å¾©æ¸¬è©¦</h1>
        <p>é€™å€‹å·¥å…·æœƒæ¸¬è©¦ä¸åŒçš„æ•¸æ“šåº« URL ä¾†æ‰¾åˆ°æ­£ç¢ºçš„é…ç½®</p>

        <div class="test-section">
            <h3>ğŸ” æ¸¬è©¦ä¸åŒçš„æ•¸æ“šåº« URL</h3>
            <div id="urlTests"></div>
            <button onclick="testAllUrls()">æ¸¬è©¦æ‰€æœ‰ URL</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æˆ¿é–“ä»£è™Ÿæ¸¬è©¦</h3>
            <div id="roomTest" class="status info">ç­‰å¾…æ¸¬è©¦...</div>
            <button onclick="testRoomIdWithBetterErrorHandling()" id="roomTestBtn" disabled>æ¸¬è©¦æˆ¿é–“ä»£è™Ÿ</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
            <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            <div id="log"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        const baseConfig = {
            apiKey: "AIzaSyD5ytWrUOI6UIUBIcKpF3fyODQR2pXFMmY",
            authDomain: "score-calculation-ef584.firebaseapp.com",
            projectId: "score-calculation-ef584",
            storageBucket: "score-calculation-ef584.firebasestorage.app",
            messagingSenderId: "634074718336",
            appId: "1:634074718336:web:38960860ad796197a50665",
            measurementId: "G-R6NT2QJQSC"
        };

        // å¯èƒ½çš„æ•¸æ“šåº« URL
        const possibleUrls = [
            "https://score-calculation-ef584-default-rtdb.firebaseio.com",
            "https://score-calculation-ef584-default-rtdb.asia-southeast1.firebasedatabase.app",
            "https://score-calculation-ef584-default-rtdb.europe-west1.firebasedatabase.app",
            "https://score-calculation-ef584-default-rtdb.us-central1.firebasedatabase.app"
        ];

        let workingUrl = null;
        let workingDatabase = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testUrl(url) {
            log(`æ¸¬è©¦ URL: ${url}`);
            
            try {
                // ä½¿ç”¨ fetch æ¸¬è©¦ URL å¯é”æ€§ï¼ˆæœŸæœ›401æ˜¯æ­£å¸¸çš„ï¼Œè¡¨ç¤ºæ•¸æ“šåº«å­˜åœ¨ä½†éœ€è¦èªè­‰ï¼‰
                const response = await fetch(`${url}/.json`);
                log(`HTTP ç‹€æ…‹: ${response.status}`);
                
                if (response.status === 200) {
                    log(`âœ… URL å¯é”ä¸”é–‹æ”¾: ${url}`);
                    return { success: true, url: url };
                } else if (response.status === 401) {
                    log(`âœ… URL å­˜åœ¨ï¼ˆéœ€è¦èªè­‰ï¼Œé€™æ˜¯æ­£å¸¸çš„ï¼‰: ${url}`);
                    return { success: true, url: url, needsAuth: true };
                } else if (response.status === 404) {
                    log(`âŒ æ•¸æ“šåº«ä¸å­˜åœ¨: ${url}`);
                    return { success: false, status: response.status };
                } else {
                    log(`âš ï¸ URL è¿”å›ç‹€æ…‹ ${response.status}ï¼Œå°‡å˜—è©¦Firebaseé€£æ¥`);
                    return { success: true, url: url, status: response.status };
                }
            } catch (error) {
                log(`âŒ URL æ¸¬è©¦å¤±æ•—: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        async function testFirebaseWithUrl(url) {
            log(`æ¸¬è©¦ Firebase é€£æ¥: ${url}`);
            
            try {
                const config = { ...baseConfig, databaseURL: url };
                
                // é‡æ–°åˆå§‹åŒ– Firebase
                if (firebase.apps.length > 0) {
                    await firebase.app().delete();
                }
                
                firebase.initializeApp(config);
                const database = firebase.database();
                
                // æ¸¬è©¦é€£æ¥ - ä½¿ç”¨.info/connectedä¾†æª¢æŸ¥é€£æ¥ç‹€æ…‹
                const testRef = database.ref('.info/connected');
                
                return new Promise((resolve) => {
                    const timeout = setTimeout(() => {
                        log(`â° Firebase é€£æ¥è¶…æ™‚: ${url}`);
                        log(`ğŸ’¡ æç¤ºï¼šå¦‚æœæŒçºŒè¶…æ™‚ï¼Œå¯èƒ½éœ€è¦æª¢æŸ¥ç¶²çµ¡æˆ–Firebaseé…ç½®`);
                        resolve({ success: false, error: 'timeout' });
                    }, 8000); // å¢åŠ è¶…æ™‚æ™‚é–“
                    
                    testRef.once('value', (snapshot) => {
                        clearTimeout(timeout);
                        if (snapshot.val() === true) {
                            log(`âœ… Firebase é€£æ¥æˆåŠŸ: ${url}`);
                            log(`ğŸ“¡ é€£æ¥ç‹€æ…‹: å·²é€£æ¥åˆ°Firebase Realtime Database`);
                            resolve({ success: true, database: database });
                        } else {
                            log(`âŒ Firebase é€£æ¥ç‹€æ…‹ç‚ºfalse: ${url}`);
                            log(`ğŸ’¡ æç¤ºï¼šå¯èƒ½æ˜¯ç¶²çµ¡å•é¡Œæˆ–æ•¸æ“šåº«é…ç½®å•é¡Œ`);
                            resolve({ success: false, error: 'connection status false' });
                        }
                    }, (error) => {
                        clearTimeout(timeout);
                        log(`âŒ Firebase é€£æ¥éŒ¯èª¤: ${error.message}`);
                        log(`ğŸ” éŒ¯èª¤ä»£ç¢¼: ${error.code || 'unknown'}`);
                        
                        // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨ºæ–·
                        if (error.code === 'PERMISSION_DENIED') {
                            log(`ğŸ’¡ æ¬Šé™è¢«æ‹’çµ•ï¼šæ•¸æ“šåº«å®‰å…¨è¦å‰‡å¯èƒ½é˜»æ­¢äº†è¨ªå•`);
                            log(`ğŸ’¡ å»ºè­°ï¼šæª¢æŸ¥Firebase Consoleä¸­çš„Database Rules`);
                        } else if (error.code === 'NETWORK_ERROR') {
                            log(`ğŸ’¡ ç¶²çµ¡éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥`);
                        }
                        
                        resolve({ success: false, error: error.message, code: error.code });
                    });
                });
                
            } catch (error) {
                log(`âŒ Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                log(`ğŸ” åˆå§‹åŒ–éŒ¯èª¤è©³æƒ…: ${error.stack || 'No stack trace'}`);
                return { success: false, error: error.message };
            }
        }

        async function testAllUrls() {
            log('=== é–‹å§‹æ¸¬è©¦æ‰€æœ‰å¯èƒ½çš„æ•¸æ“šåº« URL ===');
            
            const urlTestsDiv = document.getElementById('urlTests');
            urlTestsDiv.innerHTML = '';
            
            for (const url of possibleUrls) {
                const testDiv = document.createElement('div');
                testDiv.className = 'url-test';
                testDiv.innerHTML = `
                    <div>æ¸¬è©¦: ${url}</div>
                    <div id="result-${possibleUrls.indexOf(url)}" class="status info">æ¸¬è©¦ä¸­...</div>
                `;
                urlTestsDiv.appendChild(testDiv);
                
                const resultDiv = document.getElementById(`result-${possibleUrls.indexOf(url)}`);
                
                // å…ˆæ¸¬è©¦ HTTP å¯é”æ€§
                const httpResult = await testUrl(url);
                
                if (httpResult.success) {
                    // å†æ¸¬è©¦ Firebase é€£æ¥
                    const firebaseResult = await testFirebaseWithUrl(url);
                    
                    if (firebaseResult.success) {
                        resultDiv.textContent = 'âœ… é€£æ¥æˆåŠŸï¼';
                        resultDiv.className = 'status success';
                        workingUrl = url;
                        workingDatabase = firebaseResult.database;
                        
                        log(`ğŸ‰ æ‰¾åˆ°å¯ç”¨çš„æ•¸æ“šåº« URL: ${url}`);
                        document.getElementById('roomTestBtn').disabled = false;
                        
                        // æ›´æ–°å…¶ä»–æ¸¬è©¦ç‚ºæˆåŠŸç‹€æ…‹
                        document.getElementById('roomTest').textContent = 'æº–å‚™æ¸¬è©¦æˆ¿é–“ä»£è™ŸåŠŸèƒ½';
                        document.getElementById('roomTest').className = 'status info';
                        
                        break;
                    } else {
                        resultDiv.textContent = `âŒ Firebase é€£æ¥å¤±æ•—: ${firebaseResult.error}`;
                        resultDiv.className = 'status error';
                    }
                } else {
                    resultDiv.textContent = `âŒ URL ä¸å¯é”: ${httpResult.error || httpResult.status}`;
                    resultDiv.className = 'status error';
                }
            }
            
            if (!workingUrl) {
                log('âŒ æ²’æœ‰æ‰¾åˆ°å¯ç”¨çš„æ•¸æ“šåº« URL');
                log('');
                log('ğŸ”§ è¨ºæ–·å’Œè§£æ±ºå»ºè­°ï¼š');
                log('1. æª¢æŸ¥ Firebase Console (https://console.firebase.google.com/)');
                log('2. ç¢ºèª Realtime Database å·²å‰µå»º');
                log('3. æª¢æŸ¥æ•¸æ“šåº«å®‰å…¨è¦å‰‡ï¼Œå»ºè­°æ¸¬è©¦æ™‚ä½¿ç”¨ï¼š');
                log('   {');
                log('     "rules": {');
                log('       ".read": true,');
                log('       ".write": true');
                log('     }');
                log('   }');
                log('4. ç¢ºèªæ•¸æ“šåº«å€åŸŸè¨­ç½®æ­£ç¢º');
                log('5. æª¢æŸ¥ç¶²çµ¡é€£æ¥æ˜¯å¦æ­£å¸¸');
                log('');
                log('ğŸ“‹ ç•¶å‰æ¸¬è©¦çš„é…ç½®ï¼š');
                log(`   Project ID: ${baseConfig.projectId}`);
                log(`   API Key: ${baseConfig.apiKey.substring(0, 20)}...`);
                log('');
                showDiagnosticInfo();
            }
        }

        async function testRoomId() {
            if (!workingDatabase) {
                log('âŒ æ²’æœ‰å¯ç”¨çš„æ•¸æ“šåº«é€£æ¥');
                return;
            }
            
            log('=== æ¸¬è©¦æˆ¿é–“ä»£è™ŸåŠŸèƒ½ ===');
            
            // ç”Ÿæˆæ¸¬è©¦æˆ¿é–“ ID
            const testRoomId = 'test_' + Math.random().toString(36).substr(2, 6);
            log(`ç”Ÿæˆæ¸¬è©¦æˆ¿é–“ ID: ${testRoomId}`);
            
            try {
                // æ¸¬è©¦æˆ¿é–“æ•¸æ“šå¯«å…¥
                const roomRef = workingDatabase.ref('rooms/' + testRoomId + '/scores');
                const testScores = {
                    1: 0, 2: 0, 3: 0, 4: 0, 5: 0,
                    6: 0, 7: 0, 8: 0, 9: 0
                };
                
                await roomRef.set(testScores);
                log('âœ… æˆ¿é–“æ•¸æ“šå¯«å…¥æˆåŠŸ');
                
                // æ¸¬è©¦æ•¸æ“šè®€å–
                const snapshot = await roomRef.once('value');
                if (snapshot.exists()) {
                    log('âœ… æˆ¿é–“æ•¸æ“šè®€å–æˆåŠŸ');
                    log(`ğŸ“Š è®€å–åˆ°çš„åˆ†æ•¸: ${JSON.stringify(snapshot.val())}`);
                    
                    // æ¸¬è©¦åˆ†æ•¸æ›´æ–°
                    const updatedScores = { ...testScores };
                    updatedScores[1] = 10;
                    await roomRef.set(updatedScores);
                    log('âœ… åˆ†æ•¸æ›´æ–°æ¸¬è©¦æˆåŠŸ');
                    
                    document.getElementById('roomTest').textContent = 'âœ… æˆ¿é–“ä»£è™ŸåŠŸèƒ½æ¸¬è©¦é€šéï¼';
                    document.getElementById('roomTest').className = 'status success';
                    
                    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
                    await workingDatabase.ref('rooms/' + testRoomId).remove();
                    log('ğŸ§¹ æ¸¬è©¦æ•¸æ“šå·²æ¸…ç†');
                    
                    // é¡¯ç¤ºæ­£ç¢ºçš„é…ç½®
                    log('ğŸ‰ æ¸¬è©¦å®Œæˆï¼è«‹ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š');
                    log(`databaseURL: "${workingUrl}"`);
                    
                } else {
                    throw new Error('æ•¸æ“šè®€å–å¤±æ•—');
                }
                
            } catch (error) {
                log(`âŒ æˆ¿é–“æ¸¬è©¦å¤±æ•—: ${error.message}`);
                document.getElementById('roomTest').textContent = `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                document.getElementById('roomTest').className = 'status error';
            }
        }

        function showDiagnosticInfo() {
            log('ğŸ” é¡å¤–è¨ºæ–·ä¿¡æ¯ï¼š');
            log(`   ç€è¦½å™¨: ${navigator.userAgent.split(' ')[0]}`);
            log(`   æ™‚é–“: ${new Date().toISOString()}`);
            log(`   Firebase SDK ç‰ˆæœ¬: 9.0.0`);
            log('');
            log('ğŸŒ å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹å˜—è©¦ï¼š');
            log('- åœ¨ Firebase Console ä¸­é‡æ–°å‰µå»º Realtime Database');
            log('- ç¢ºèªé …ç›®è¨ˆè²»ç‹€æ…‹ï¼ˆå…è²»æ–¹æ¡ˆæœ‰é™åˆ¶ï¼‰');
            log('- æª¢æŸ¥æ˜¯å¦æœ‰é˜²ç«ç‰†é˜»æ­¢é€£æ¥');
            log('- å˜—è©¦åœ¨ç„¡ç—•æ¨¡å¼ä¸‹æ¸¬è©¦');
        }

        async function testRoomIdWithBetterErrorHandling() {
            if (!workingDatabase) {
                log('âŒ æ²’æœ‰å¯ç”¨çš„æ•¸æ“šåº«é€£æ¥');
                return;
            }
            
            log('=== æ¸¬è©¦æˆ¿é–“ä»£è™ŸåŠŸèƒ½ï¼ˆå¢å¼·ç‰ˆï¼‰ ===');
            
            // ç”Ÿæˆæ¸¬è©¦æˆ¿é–“ ID
            const testRoomId = 'test_' + Math.random().toString(36).substr(2, 6);
            log(`ç”Ÿæˆæ¸¬è©¦æˆ¿é–“ ID: ${testRoomId}`);
            
            try {
                // é¦–å…ˆæ¸¬è©¦åŸºæœ¬çš„è®€å–æ¬Šé™
                log('ğŸ” æ¸¬è©¦æ•¸æ“šåº«è®€å–æ¬Šé™...');
                const rootRef = workingDatabase.ref('/');
                
                try {
                    await rootRef.once('value');
                    log('âœ… æ•¸æ“šåº«è®€å–æ¬Šé™æ­£å¸¸');
                } catch (readError) {
                    log(`âŒ æ•¸æ“šåº«è®€å–æ¬Šé™è¢«æ‹’çµ•: ${readError.message}`);
                    if (readError.code === 'PERMISSION_DENIED') {
                        log('ğŸ’¡ è«‹æª¢æŸ¥Firebaseå®‰å…¨è¦å‰‡ï¼Œç¢ºä¿å…è¨±è®€å–æ“ä½œ');
                    }
                    throw readError;
                }
                
                // æ¸¬è©¦å¯«å…¥æ¬Šé™
                log('ğŸ” æ¸¬è©¦æ•¸æ“šåº«å¯«å…¥æ¬Šé™...');
                const roomRef = workingDatabase.ref('rooms/' + testRoomId + '/scores');
                const testScores = {
                    1: 0, 2: 0, 3: 0, 4: 0, 5: 0,
                    6: 0, 7: 0, 8: 0, 9: 0
                };
                
                await roomRef.set(testScores);
                log('âœ… æˆ¿é–“æ•¸æ“šå¯«å…¥æˆåŠŸ');
                
                // æ¸¬è©¦æ•¸æ“šè®€å–
                const snapshot = await roomRef.once('value');
                if (snapshot.exists()) {
                    log('âœ… æˆ¿é–“æ•¸æ“šè®€å–æˆåŠŸ');
                    log(`ğŸ“Š è®€å–åˆ°çš„åˆ†æ•¸: ${JSON.stringify(snapshot.val())}`);
                    
                    // æ¸¬è©¦åˆ†æ•¸æ›´æ–°
                    const updatedScores = { ...testScores };
                    updatedScores[1] = 10;
                    await roomRef.set(updatedScores);
                    log('âœ… åˆ†æ•¸æ›´æ–°æ¸¬è©¦æˆåŠŸ');
                    
                    // æ¸¬è©¦å¯¦æ™‚ç›£è½
                    log('ğŸ” æ¸¬è©¦å¯¦æ™‚æ•¸æ“šç›£è½...');
                    const listenPromise = new Promise((resolve) => {
                        const listener = roomRef.on('value', (snapshot) => {
                            log('âœ… å¯¦æ™‚ç›£è½åŠŸèƒ½æ­£å¸¸');
                            roomRef.off('value', listener);
                            resolve();
                        });
                        
                        setTimeout(() => {
                            roomRef.off('value', listener);
                            resolve();
                        }, 2000);
                    });
                    
                    await listenPromise;
                    
                    document.getElementById('roomTest').textContent = 'âœ… æˆ¿é–“ä»£è™ŸåŠŸèƒ½æ¸¬è©¦å®Œå…¨é€šéï¼';
                    document.getElementById('roomTest').className = 'status success';
                    
                    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
                    await workingDatabase.ref('rooms/' + testRoomId).remove();
                    log('ğŸ§¹ æ¸¬è©¦æ•¸æ“šå·²æ¸…ç†');
                    
                    // é¡¯ç¤ºæ­£ç¢ºçš„é…ç½®
                    log('');
                    log('ğŸ‰ æ¸¬è©¦å®Œæˆï¼æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼');
                    log('ğŸ“‹ è«‹åœ¨ä½ çš„æ‡‰ç”¨ä¸­ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š');
                    log(`databaseURL: "${workingUrl}"`);
                    log('');
                    log('âœ… ç¢ºèªåŠŸèƒ½ï¼š');
                    log('- âœ… Firebaseé€£æ¥');
                    log('- âœ… æ•¸æ“šè®€å–');
                    log('- âœ… æ•¸æ“šå¯«å…¥');
                    log('- âœ… å¯¦æ™‚ç›£è½');
                    log('- âœ… æˆ¿é–“ç®¡ç†');
                    
                } else {
                    throw new Error('æ•¸æ“šè®€å–å¤±æ•—ï¼šå¯«å…¥çš„æ•¸æ“šç„¡æ³•è®€å–');
                }
                
            } catch (error) {
                log(`âŒ æˆ¿é–“æ¸¬è©¦å¤±æ•—: ${error.message}`);
                log(`ğŸ” éŒ¯èª¤ä»£ç¢¼: ${error.code || 'unknown'}`);
                
                if (error.code === 'PERMISSION_DENIED') {
                    log('');
                    log('ğŸ”§ æ¬Šé™å•é¡Œè§£æ±ºæ–¹æ¡ˆï¼š');
                    log('1. æ‰“é–‹ Firebase Console');
                    log('2. é€²å…¥ Realtime Database');
                    log('3. é»æ“Š "è¦å‰‡" æ¨™ç±¤');
                    log('4. æš«æ™‚è¨­ç½®ç‚ºï¼š');
                    log('   {');
                    log('     "rules": {');
                    log('       ".read": true,');
                    log('       ".write": true');
                    log('     }');
                    log('   }');
                    log('5. é»æ“Š "ç™¼å¸ƒ"');
                    log('âš ï¸ æ³¨æ„ï¼šé€™æ˜¯æ¸¬è©¦ç”¨è¦å‰‡ï¼Œæ­£å¼ç’°å¢ƒéœ€è¦æ›´åš´æ ¼çš„å®‰å…¨è¦å‰‡');
                }
                
                document.getElementById('roomTest').textContent = `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                document.getElementById('roomTest').className = 'status error';
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•é–‹å§‹æ¸¬è©¦
        window.addEventListener('load', function() {
            log('ğŸš€ å¿«é€Ÿä¿®å¾©æ¸¬è©¦å·¥å…·å•Ÿå‹•');
            setTimeout(testAllUrls, 1000);
        });
    </script>
</body>
</html>